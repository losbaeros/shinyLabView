---
title: "ShinyLabView"
output: 
  flexdashboard::flex_dashboard:
runtime: shiny
---

```{r global, include=FALSE}
library(data.table)
library(DT)
library(lubridate)
labData <- read.csv("./dummyValues.csv") # loading data in global needs to be done only once.
patData <- read.csv2("./patientData.csv")
combinedData <- merge(labData, patData, by = "patientId")
```

Sidebar {.sidebar}
-----------------------------------------------------------------------
```{r}
# prepare patient selection with helper vector:
# - selectInput takes a named vector to display names coded with an id:
#   See: http://shiny.rstudio.com/reference/shiny/latest/selectInput.html
#   and: https://www.dummies.com/programming/r/how-to-name-the-values-in-your-vectors-in-r/
patData<- patData[order(patData$name), ]
patSelectors <- patData$patientId
names(patSelectors) <- paste(as.character(patData$name), 
                             as.character(patData$firstName),
                             sep = ", ")

selectInput("patId", label = "Patient",
            choices = patSelectors)
```

Column
-----------------------------------------------------------------------
```{r}
combinedData$date <- as_datetime(combinedData$date, 
                                 origin = lubridate::origin, 
                                 tz = "UTC") # convert int to unixTs-obj.
combinedData$date <- format(combinedData$date, 
                            format = "%y-%m-%d %H:%M") # convert unixTs to human readable string

displayData <- reactive({ # build a reactive component
  displayData <- combinedData[combinedData$patientId == input$patId, ] # select by patientId
  displayData <- displayData[order(displayData$date, decreasing = TRUE), ] # sort by date
  rownames(displayData) <- displayData$date # set date as rowname (can't be done earlier, because of likely duplicates)
  displayData <- subset(displayData, select = c(na, k, krea, hst, gfr, hgb, rbc, plt, wbc, inr, ptt))
  displayData <- t(displayData) # transpose table (in order to get that sweet "Kummulativbericht-feeling")
})

DT::renderDataTable( # see: https://rstudio.github.io/DT/options.html
  datatable( # using a seperate datatable-obj. to enable formatRounding.
    data = displayData(),
    class = "white-space: nowrap", # disable linebreaks: https://github.com/rstudio/DT/issues/353#issuecomment-244509696
    options = list(ordering = FALSE) # ordering makes no sense in a turned table
  )
  %>% formatRound(c(1:999), 2) # see: https://stackoverflow.com/questions/33171279/dt-in-shiny-and-r-custom-number-formatting
)
```
